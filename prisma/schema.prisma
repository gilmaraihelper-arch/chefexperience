// ChefExperience - Schema Completo
// Marketplace B2B2C de gastronomia

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================
enum UserType {
  CLIENT
  PROFESSIONAL
  ADMIN
}

enum PersonType {
  PF
  PJ
}

enum EventType {
  CASAMENTO
  ANIVERSARIO
  CORPORATIVO
  FORMATURA
  CONFRATERNIZACAO
  JANTAR
  COQUETEL
  FESTA_INFANTIL
  DEBUTANTE
  BODAS
  CHA_BEBE
  NOIVADO
}

enum ServiceType {
  BUFFET
  PRATO_FECHADO
  COQUETEL
  CHURRASCO
  COFFEE_BREAK
  BRUNCH
  ANTEPASTOS
  OUTROS
}

enum CuisineStyle {
  BRASILEIRA
  ITALIANA
  ITALIANO_MASSAS
  ITALIANO_PIZZA
  FRANCESA
  JAPONESA
  MEXICANA
  ARABE
  CHURRASCO
  FRUTOS_DO_MAR
  VEGETARIANA
  VEGANA
  SEM_GLUTEN
  SEM_LACTOSE
  MEDITERRANEA
  FUSION
  COZINHA_AUTOR
  OUTROS
}

enum PriceRange {
  POPULAR
  EXECUTIVO
  PREMIUM
  LUXO
  ULTRA_LUXO
}

enum ProposalStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum SubscriptionPlan {
  FREE
  PROFESSIONAL
  PREMIUM
  ENTERPRISE
}

// ============================================
// USUÁRIO BASE
// ============================================
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String?   // Opcional para OAuth
  phone         String?
  whatsapp      String?
  type          UserType
  personType    PersonType
  
  name          String
  cpf           String?
  cnpj          String?
  razaoSocial   String?
  nomeFantasia  String?
  
  cep           String
  address       String
  number        String
  complement    String?
  neighborhood  String
  city          String
  state         String
  
  latitude      Float?
  longitude     Float?
  
  isActive      Boolean   @default(true)
  isVerified    Boolean   @default(false)
  emailVerified DateTime? // Para OAuth
  image         String?   // Avatar do OAuth
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  // Relações
  clientProfile     ClientProfile?
  professionalProfile ProfessionalProfile?
  sentMessages      Message[] @relation("SentMessages")
  receivedMessages  Message[] @relation("ReceivedMessages")
  notifications     Notification[]
  sessions          Session[]
  reviews           Review[]
  
  // NextAuth relations
  accounts          Account[]
  nextauthSessions  NextAuthSession[]
  
  @@index([email])
  @@index([city, state])
}

// ============================================
// PERFIL DE CLIENTE
// ============================================
model ClientProfile {
  id        String @id @default(uuid())
  userId    String @unique
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  totalEvents     Int @default(0)
  totalSpent      Float @default(0)
  
  events    Event[]
}

// ============================================
// PERFIL DE PROFISSIONAL
// ============================================
model ProfessionalProfile {
  id              String @id @default(uuid())
  userId          String @unique
  user            User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  slogan          String?
  description     String
  experience      String?
  differentials   String?
  
  eventTypes      String   // JSON array
  cuisineStyles   String   // JSON array
  serviceTypes    String   // JSON array
  priceRanges     String   // JSON array
  capacity        String   // JSON array de inteiros
  
  hasWaiter       Boolean @default(false)
  hasSoftDrinks   Boolean @default(false)
  hasAlcoholicDrinks Boolean @default(false)
  hasDecoration   Boolean @default(false)
  hasRental       Boolean @default(false)
  hasSoundLight   Boolean @default(false)
  hasPhotographer Boolean @default(false)
  hasBartender    Boolean @default(false)
  hasSweets       Boolean @default(false)
  hasCake         Boolean @default(false)
  hasPlatesCutlery Boolean @default(false)
  
  serviceRadiusKm Int @default(50)
  
  subscriptionPlan SubscriptionPlan @default(FREE)
  subscriptionExpiresAt DateTime?
  
  rating          Float @default(0)
  reviewCount     Int @default(0)
  totalEvents     Int @default(0)
  totalEarned     Float @default(0)
  
  availabilityJson String?
  
  packages    Package[]
  proposals   Proposal[]
  portfolio   PortfolioImage[]
  reviews     Review[] @relation("ProfessionalReviews")
  certifications Certification[]
  
  @@index([subscriptionPlan])
  @@index([rating])
}

// ============================================
// PACOTES PRÉ-DEFINIDOS
// ============================================
model Package {
  id              String @id @default(uuid())
  professionalId  String
  professional    ProfessionalProfile @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  
  name            String
  description     String
  basePrice       Float
  minPeople       Int
  maxPeople       Int
  
  includes        String   // JSON array
  
  menuFileUrl     String?
  
  isActive        Boolean @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// IMAGENS DO PORTFÓLIO
// ============================================
model PortfolioImage {
  id              String @id @default(uuid())
  professionalId  String
  professional    ProfessionalProfile @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  
  url             String
  description     String?
  isMain          Boolean @default(false)
  createdAt       DateTime @default(now())
}

// ============================================
// EVENTO (CRIADO PELO CLIENTE)
// ============================================
model Event {
  id              String @id @default(uuid())
  clientId        String
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  name            String
  eventType       String   // EventType como string
  
  date            DateTime
  startTime       String?
  duration        String?
  
  billingType     String   // PF ou PJ
  
  locationType    String
  address         String
  city            String
  state           String
  hasKitchen      Boolean @default(false)
  
  latitude        Float?
  longitude       Float?
  
  guestCount      Int
  
  searchRadiusKm  Int @default(50)
  
  cuisineStyles   String   // JSON array
  serviceTypes    String   // JSON array
  
  needsWaiter     Boolean @default(false)
  needsSoftDrinks Boolean @default(false)
  needsAlcoholicDrinks Boolean @default(false)
  needsDecoration Boolean @default(false)
  needsSoundLight Boolean @default(false)
  needsPhotographer Boolean @default(false)
  needsBartender  Boolean @default(false)
  needsSweets     Boolean @default(false)
  needsCake       Boolean @default(false)
  needsPlatesCutlery Boolean @default(false)
  
  priceRange      String   // PriceRange como string
  maxBudget       Float?
  
  description     String?
  dietaryRestrictions String?
  
  referenceImages String   // JSON array de URLs
  
  status          String @default("OPEN") // OPEN, CLOSED, CANCELLED, COMPLETED
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  expiresAt       DateTime?
  
  proposals       Proposal[]
  hiredProposalId String? @unique
  hiredProposal   Proposal? @relation("HiredProposal", fields: [hiredProposalId], references: [id])
  
  @@index([clientId])
  @@index([status])
}

// ============================================
// PROPOSTA/ORÇAMENTO
// ============================================
model Proposal {
  id              String @id @default(uuid())
  
  eventId         String
  event           Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  professionalId  String
  professional    ProfessionalProfile @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  
  totalPrice      Float
  pricePerPerson  Float?
  
  message         String?
  
  attachmentUrl   String?
  
  packageId       String?
  
  status          String @default("PENDING") // PENDING, ACCEPTED, REJECTED, EXPIRED

  hiredForEvent   Event? @relation("HiredProposal")
  
  sentAt          DateTime @default(now())
  respondedAt     DateTime?
  expiresAt       DateTime?

  @@unique([eventId, professionalId])
  @@index([professionalId])
  @@index([status])
}

// ============================================
// AVALIAÇÕES
// ============================================
model Review {
  id              String @id @default(uuid())
  
  reviewerId      String
  reviewer        User @relation(fields: [reviewerId], references: [id], onDelete: Cascade)
  
  professionalId  String
  professional    ProfessionalProfile @relation("ProfessionalReviews", fields: [professionalId], references: [id], onDelete: Cascade)
  
  eventId         String
  
  foodQuality     Int
  serviceQuality  Int
  punctuality     Int
  communication   Int
  valueForMoney   Int
  overall         Int
  
  comment         String
  
  response        String?
  respondedAt     DateTime?
  
  isPublic        Boolean @default(true)
  
  createdAt       DateTime @default(now())
  
  @@unique([reviewerId, eventId])
  @@index([professionalId])
}

// ============================================
// MENSAGENS (CHAT)
// ============================================
model Message {
  id              String @id @default(uuid())
  
  senderId        String
  sender          User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  
  receiverId      String
  receiver        User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  
  eventId         String?
  proposalId      String?
  
  content         String
  attachments     String   // JSON array de URLs
  
  isRead          Boolean @default(false)
  readAt          DateTime?
  
  createdAt       DateTime @default(now())
  
  @@index([senderId, receiverId])
  @@index([eventId])
}

// ============================================
// NOTIFICAÇÕES
// ============================================
model Notification {
  id          String @id @default(uuid())
  userId      String
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        String
  title       String
  message     String
  
  data        String?  // JSON
  
  actionUrl   String?
  
  isRead      Boolean @default(false)
  readAt      DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([userId, isRead])
}

// ============================================
// SESSÕES (PARA REFRESH TOKEN)
// ============================================
model Session {
  id          String @id @default(uuid())
  userId      String
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  refreshToken String @unique
  
  deviceInfo  String?
  ipAddress   String?
  
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([refreshToken])
}

// ============================================
// CERTIFICAÇÕES (PROFISSIONAL)
// ============================================
model Certification {
  id              String @id @default(uuid())
  professionalId  String
  professional    ProfessionalProfile @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  
  name            String
  institution     String?
  year            Int?
  fileUrl         String?
  
  createdAt       DateTime @default(now())
}

// ============================================
// NEXTAUTH - OAUTH ACCOUNTS
// ============================================
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// ============================================
// NEXTAUTH - SESSIONS
// ============================================
model NextAuthSession {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("nextauth_sessions")
}

// ============================================
// NEXTAUTH - VERIFICATION TOKENS
// ============================================
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}
